name: 'Agent Trust Scan'
description: 'Validate agent/tool endpoints across A2A, MCP, and llms.txt protocols'
author: 'Agent Trust'

branding:
  icon: 'shield'
  color: 'blue'

inputs:
  domains:
    description: 'Comma-separated list of domains to scan, or path to file with domains'
    required: true
  fail-on:
    description: 'Fail the action on: warn|fail (default: fail)'
    required: false
    default: 'fail'
  format:
    description: 'Output format: table|json|markdown (default: markdown)'
    required: false
    default: 'markdown'
  post-comment:
    description: 'Post results as PR comment (requires github-token)'
    required: false
    default: 'false'
  github-token:
    description: 'GitHub token for posting PR comments (use ${{ secrets.GITHUB_TOKEN }})'
    required: false

outputs:
  score:
    description: 'Overall scan score (0-100)'
    value: ${{ steps.scan.outputs.score }}
  passed:
    description: 'Whether all checks passed'
    value: ${{ steps.scan.outputs.passed }}
  report:
    description: 'Full scan report (JSON)'
    value: ${{ steps.scan.outputs.report }}

runs:
  using: 'composite'
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Check dependencies
      shell: bash
      run: |
        if ! command -v jq &> /dev/null; then
          echo "Error: jq is required but not installed"
          exit 1
        fi
    
    - name: Build agent-trust-scan
      shell: bash
      run: |
        # Use the local checkout instead of installing from npm
        cd $GITHUB_ACTION_PATH
        npm ci
        npm run build
    
    - name: Run scan
      id: scan
      shell: bash
      env:
        DOMAINS: ${{ inputs.domains }}
        FORMAT: ${{ inputs.format }}
        FAIL_ON: ${{ inputs.fail-on }}
        POST_COMMENT: ${{ inputs.post-comment }}
      run: |
        # Use local build instead of global install
        SCAN_BIN="node $GITHUB_ACTION_PATH/dist/cli.js"
        
        # Determine if domains is a file or comma-separated list
        if [ -f "$DOMAINS" ]; then
          DOMAINS_ARG="--domains $DOMAINS"
        else
          # Convert comma-separated to newline-separated
          DOMAINS_FILE=$(mktemp)
          echo "$DOMAINS" | tr ',' '\n' > "$DOMAINS_FILE"
          DOMAINS_ARG="--domains $DOMAINS_FILE"
        fi
        
        # Run scan and capture output (allow failure for now)
        set +e
        REPORT_JSON=$($SCAN_BIN $DOMAINS_ARG --format json)
        EXIT_CODE=$?
        set -e
        
        # Check if scan output is empty
        if [ -z "$REPORT_JSON" ]; then
          echo "Error: Scan produced no output (exit code: $EXIT_CODE)"
          echo "score=0" >> $GITHUB_OUTPUT
          echo "passed=false" >> $GITHUB_OUTPUT
          echo "report={}" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        echo "$REPORT_JSON" > scan-report.json
        
        # Extract score (handle both single domain and multi-domain)
        SCORE=$(echo "$REPORT_JSON" | jq -r 'if type == "array" then .[0].score else .score end')
        echo "score=$SCORE" >> $GITHUB_OUTPUT
        
        # Check if all passed
        FAIL_COUNT=$(echo "$REPORT_JSON" | jq -r '
          if type == "array" then 
            [.[] | .checks | to_entries[] | select(.value.status == "fail")] | length
          else 
            [.checks | to_entries[] | select(.value.status == "fail")] | length
          end
        ')
        WARN_COUNT=$(echo "$REPORT_JSON" | jq -r '
          if type == "array" then 
            [.[] | .checks | to_entries[] | select(.value.status == "warn")] | length
          else 
            [.checks | to_entries[] | select(.value.status == "warn")] | length
          end
        ')
        
        echo "report<<EOF" >> $GITHUB_OUTPUT
        echo "$REPORT_JSON" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        # Generate markdown report if post-comment is true OR format is markdown
        if [ "$POST_COMMENT" = "true" ] || [ "$FORMAT" = "markdown" ]; then
          $SCAN_BIN $DOMAINS_ARG --format markdown > scan-report.md
          echo "markdown-report<<EOF" >> $GITHUB_OUTPUT
          cat scan-report.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        fi
        
        # Determine pass/fail
        if [ "$FAIL_ON" = "warn" ] && [ "$WARN_COUNT" -gt 0 ]; then
          echo "passed=false" >> $GITHUB_OUTPUT
          exit 1
        elif [ "$FAIL_COUNT" -gt 0 ]; then
          echo "passed=false" >> $GITHUB_OUTPUT
          exit 1
        else
          echo "passed=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Post PR comment
      if: inputs.post-comment == 'true' && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.github-token }}
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('scan-report.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## üîç Agent Trust Scan Results\n\n${report}`
          });
